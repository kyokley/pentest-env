package 'apt-transport-https'
include_recipe 'apt'
package 'dirmngr'

directory '/etc/kubernetes/manifests' do
  recursive true
end

ip = node['pentest-env']['k8s']['master_ip']
port = node['pentest-env']['k8s']['master_port']

docker_service 'default' do
  version '17.06.1'
  install_method 'package'
  storage_driver 'devicemapper'
  iptables false
  ip_masq false
end

kubelet_service 'default' do
  api_servers "http://#{ip}:#{port}"
  pod_manifest_path '/etc/kubernetes/manifests'
  pod_cidr '10.180.1.0/24'
  cluster_dns '10.0.0.10'
  cluster_domain 'cluster.local'
  action %w[create start]
end

kube_proxy 'default' do
  master "#{ip}:#{port}"
  action %w[create start]
end
