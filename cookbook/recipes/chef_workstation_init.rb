hostsfile_entry node['pentest-env']['chef_server_ip'] do
  hostname node['pentest-env']['chef_server_host']
  unique true
end

script 'chef-workstation-init' do
  interpreter 'bash'
  code <<-SCRIPT
  mkdir -p /root/.chef
  cp /vagrant/data/chef-server-admin.pem /root/.chef/admin.pem
  SCRIPT
  not_if 'test -f /etc/chef/client.pem'
end

file '/root/.chef/knife.rb' do
  owner 'root'
  group 'root'
  mode '0644'
  content <<-KNIFE
  node_name 'admin'
  client_key '/root/.chef/admin.pem'
  validator_client_name 'pentest-env-validator'
  chef_server_url 'https://#{node['pentest-env']['chef_server_host']}/organizations/pentest-env'
  cookbook_path '/vagrant/berks-cookbooks'
  role_path '/vagrant/chef-repo/roles'
  KNIFE
end

chef_gem 'knife-acl'

execute 'knife ssl fetch' do
  not_if 'knife ssl check'
end
